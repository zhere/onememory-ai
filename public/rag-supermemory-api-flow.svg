<?xml version="1.0" encoding="UTF-8"?>
<svg width="900" height="1200" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#666"/>
    </marker>
    <marker id="arrow-orange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#FF8C00"/>
    </marker>
    <marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#4682B4"/>
    </marker>
    <marker id="arrow-purple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#8A2BE2"/>
    </marker>
    <marker id="arrow-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#2E8B57"/>
    </marker>
    <marker id="arrow-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <path d="M0,0 L0,6 L9,3 z" fill="#CD5C5C"/>
    </marker>
  </defs>

  <!-- 背景 -->
  <rect width="900" height="1200" fill="#FFFFFF"/>
  
  <!-- 标题 -->
  <text x="450" y="30" font-family="Arial" font-size="20" text-anchor="middle" font-weight="bold">RAG与Supermemory融合架构API流程图</text>
  
  <!-- 图例 -->
  <g transform="translate(50, 50)">
    <text x="0" y="0" font-family="Arial" font-size="12" font-weight="bold">图例:</text>
    <line x1="0" y1="15" x2="30" y2="15" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
    <text x="35" y="18" font-family="Arial" font-size="10">标准API流</text>
    
    <line x1="150" y1="15" x2="180" y2="15" stroke="#FF8C00" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrow-orange)"/>
    <text x="185" y="18" font-family="Arial" font-size="10">结果回写流</text>
    
    <line x1="300" y1="15" x2="330" y2="15" stroke="#4682B4" stroke-width="2" marker-end="url(#arrow-blue)"/>
    <text x="335" y="18" font-family="Arial" font-size="10">RAG流</text>
    
    <line x1="400" y1="15" x2="430" y2="15" stroke="#8A2BE2" stroke-width="2" marker-end="url(#arrow-purple)"/>
    <text x="435" y="18" font-family="Arial" font-size="10">Supermemory流</text>
    
    <line x1="550" y1="15" x2="580" y2="15" stroke="#2E8B57" stroke-width="2" marker-end="url(#arrow-green)"/>
    <text x="585" y="18" font-family="Arial" font-size="10">融合流</text>
    
    <line x1="650" y1="15" x2="680" y2="15" stroke="#CD5C5C" stroke-width="2" marker-end="url(#arrow-red)"/>
    <text x="685" y="18" font-family="Arial" font-size="10">LLM流</text>
  </g>

  <!-- 客户端 -->
  <rect x="350" y="100" width="200" height="50" rx="5" ry="5" fill="#E6F7FF" stroke="#333"/>
  <text x="450" y="130" font-family="Arial" font-size="14" text-anchor="middle">客户端应用</text>
  
  <!-- API网关 -->
  <rect x="350" y="200" width="200" height="50" rx="5" ry="5" fill="#E6FFE6" stroke="#333"/>
  <text x="450" y="225" font-family="Arial" font-size="14" text-anchor="middle">API网关</text>
  <text x="450" y="240" font-family="Arial" font-size="10" text-anchor="middle">POST /v1/chat</text>
  
  <!-- 核心服务 -->
  <rect x="350" y="300" width="200" height="50" rx="5" ry="5" fill="#FFF0E6" stroke="#333"/>
  <text x="450" y="325" font-family="Arial" font-size="14" text-anchor="middle">核心服务层</text>
  <text x="450" y="340" font-family="Arial" font-size="10" text-anchor="middle">POST /v1/chat/completions</text>
  
  <!-- RAG系统 -->
  <rect x="100" y="400" width="200" height="250" rx="5" ry="5" fill="#F0E6FF" stroke="#333"/>
  <text x="200" y="420" font-family="Arial" font-size="14" text-anchor="middle">RAG系统</text>
  
  <!-- RAG组件 -->
  <rect x="120" y="440" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="200" y="460" font-family="Arial" font-size="12" text-anchor="middle">知识源管理器</text>
  <text x="200" y="472" font-family="Arial" font-size="8" text-anchor="middle">GET/POST /v1/rag-knowledge/sources</text>
  
  <rect x="120" y="480" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="200" y="500" font-family="Arial" font-size="12" text-anchor="middle">向量数据库连接器</text>
  
  <rect x="120" y="520" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="200" y="540" font-family="Arial" font-size="12" text-anchor="middle">嵌入引擎</text>
  
  <rect x="120" y="560" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="200" y="580" font-family="Arial" font-size="12" text-anchor="middle">相似度检索器</text>
  
  <rect x="120" y="600" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="200" y="620" font-family="Arial" font-size="12" text-anchor="middle">RAG检索API</text>
  <text x="200" y="632" font-family="Arial" font-size="8" text-anchor="middle">GET /v1/rag-knowledge/retrieve</text>
  
  <!-- Supermemory系统 -->
  <rect x="600" y="400" width="200" height="250" rx="5" ry="5" fill="#FFE6F0" stroke="#333"/>
  <text x="700" y="420" font-family="Arial" font-size="14" text-anchor="middle">Supermemory系统</text>
  
  <!-- Supermemory组件 -->
  <rect x="620" y="440" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="700" y="460" font-family="Arial" font-size="12" text-anchor="middle">记忆管理器</text>
  <text x="700" y="472" font-family="Arial" font-size="8" text-anchor="middle">GET /v1/memory/conversations</text>
  
  <rect x="620" y="480" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="700" y="500" font-family="Arial" font-size="12" text-anchor="middle">智能分段器</text>
  <text x="700" y="512" font-family="Arial" font-size="8" text-anchor="middle">POST /v1/segmentation/process</text>
  
  <rect x="620" y="520" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="700" y="540" font-family="Arial" font-size="12" text-anchor="middle">知识图谱存储</text>
  <text x="700" y="552" font-family="Arial" font-size="8" text-anchor="middle">GET/POST /v1/zep-graphiti/entities</text>
  
  <rect x="620" y="560" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="700" y="580" font-family="Arial" font-size="12" text-anchor="middle">关系引擎</text>
  <text x="700" y="592" font-family="Arial" font-size="8" text-anchor="middle">POST /v1/zep-graphiti/relations/infer</text>
  
  <rect x="620" y="600" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="700" y="620" font-family="Arial" font-size="12" text-anchor="middle">记忆检索/更新API</text>
  <text x="700" y="632" font-family="Arial" font-size="8" text-anchor="middle">POST /v1/memory/retrieve, PUT /v1/memory/update</text>
  
  <!-- 融合层 -->
  <rect x="250" y="700" width="400" height="200" rx="5" ry="5" fill="#E6F0FF" stroke="#333"/>
  <text x="450" y="720" font-family="Arial" font-size="14" text-anchor="middle">融合层</text>
  
  <!-- 融合组件 -->
  <rect x="270" y="740" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="350" y="760" font-family="Arial" font-size="12" text-anchor="middle">并行检索协调器</text>
  <text x="350" y="772" font-family="Arial" font-size="8" text-anchor="middle">POST /v1/fusion/retrieve</text>
  
  <rect x="270" y="780" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="350" y="800" font-family="Arial" font-size="12" text-anchor="middle">融合策略引擎</text>
  <text x="350" y="812" font-family="Arial" font-size="8" text-anchor="middle">POST /v1/fusion/strategy</text>
  
  <rect x="270" y="820" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="350" y="840" font-family="Arial" font-size="12" text-anchor="middle">上下文组装器</text>
  <text x="350" y="852" font-family="Arial" font-size="8" text-anchor="middle">POST /v1/fusion/context</text>
  
  <rect x="470" y="740" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="550" y="760" font-family="Arial" font-size="12" text-anchor="middle">洞察生成器</text>
  <text x="550" y="772" font-family="Arial" font-size="8" text-anchor="middle">POST /v1/memory/insights/generate</text>
  
  <rect x="470" y="780" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="550" y="800" font-family="Arial" font-size="12" text-anchor="middle">结果回写处理器</text>
  <text x="550" y="812" font-family="Arial" font-size="8" text-anchor="middle">POST /v1/fusion/feedback</text>
  
  <rect x="470" y="820" width="160" height="30" rx="3" ry="3" fill="#FFFFFF" stroke="#333"/>
  <text x="550" y="840" font-family="Arial" font-size="12" text-anchor="middle">记忆更新触发器</text>
  <text x="550" y="852" font-family="Arial" font-size="8" text-anchor="middle">PUT /v1/memory/update/from-fusion</text>
  
  <!-- LLM适配器 -->
  <rect x="350" y="950" width="200" height="50" rx="5" ry="5" fill="#F5F5F5" stroke="#333"/>
  <text x="450" y="975" font-family="Arial" font-size="14" text-anchor="middle">LLM适配器</text>
  <text x="450" y="990" font-family="Arial" font-size="10" text-anchor="middle">POST /v1/llm/generate</text>
  
  <!-- 数据存储 -->
  <rect x="100" y="1050" width="200" height="50" rx="5" ry="5" fill="#E0E0E0" stroke="#333"/>
  <text x="200" y="1075" font-family="Arial" font-size="14" text-anchor="middle">向量数据库</text>
  <text x="200" y="1090" font-family="Arial" font-size="10" text-anchor="middle">PostgreSQL + pgvector</text>
  
  <rect x="600" y="1050" width="200" height="50" rx="5" ry="5" fill="#E0E0E0" stroke="#333"/>
  <text x="700" y="1075" font-family="Arial" font-size="14" text-anchor="middle">知识图谱存储</text>
  <text x="700" y="1090" font-family="Arial" font-size="10" text-anchor="middle">PostgreSQL + Zep Graphiti</text>
  
  <!-- 连接线 - 主流程 -->
  <!-- 客户端到API网关 -->
  <line x1="450" y1="150" x2="450" y2="200" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="460" y="180" font-family="Arial" font-size="10">1. POST /v1/chat</text>
  
  <!-- API网关到核心服务 -->
  <line x1="450" y1="250" x2="450" y2="300" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="460" y="280" font-family="Arial" font-size="10">2. POST /v1/chat/completions</text>
  
  <!-- 核心服务到RAG和Supermemory的并行请求 -->
  <line x1="450" y1="350" x2="200" y2="400" stroke="#4682B4" stroke-width="2" marker-end="url(#arrow-blue)"/>
  <text x="280" y="380" font-family="Arial" font-size="10">3a. GET /v1/rag-knowledge/retrieve</text>
  
  <line x1="450" y1="350" x2="700" y2="400" stroke="#8A2BE2" stroke-width="2" marker-end="url(#arrow-purple)"/>
  <text x="600" y="380" font-family="Arial" font-size="10">3b. POST /v1/memory/retrieve</text>
  
  <!-- RAG和Supermemory到融合层 -->
  <line x1="200" y1="650" x2="350" y2="700" stroke="#4682B4" stroke-width="2" marker-end="url(#arrow-blue)"/>
  <text x="250" y="680" font-family="Arial" font-size="10">4a. RAG检索结果</text>
  
  <line x1="700" y1="650" x2="550" y2="700" stroke="#8A2BE2" stroke-width="2" marker-end="url(#arrow-purple)"/>
  <text x="650" y="680" font-family="Arial" font-size="10">4b. Supermemory检索结果</text>
  
  <!-- 融合层内部流程 -->
  <line x1="350" y1="770" x2="350" y2="780" stroke="#2E8B57" stroke-width="2" marker-end="url(#arrow-green)"/>
  <text x="320" y="775" font-family="Arial" font-size="8">5a. 融合策略</text>
  
  <line x1="350" y1="810" x2="350" y2="820" stroke="#2E8B57" stroke-width="2" marker-end="url(#arrow-green)"/>
  <text x="320" y="815" font-family="Arial" font-size="8">5b. 上下文组装</text>
  
  <line x1="430" y1="755" x2="470" y2="755" stroke="#2E8B57" stroke-width="2" marker-end="url(#arrow-green)"/>
  <text x="440" y="745" font-family="Arial" font-size="8">5c. 洞察生成</text>
  
  <!-- 融合层到LLM适配器 -->
  <line x1="450" y1="900" x2="450" y2="950" stroke="#CD5C5C" stroke-width="2" marker-end="url(#arrow-red)"/>
  <text x="460" y="930" font-family="Arial" font-size="10">6. POST /v1/llm/generate</text>
  
  <!-- LLM适配器回到核心服务 -->
  <line x1="350" y1="950" x2="300" y2="350" stroke="#CD5C5C" stroke-width="2" marker-end="url(#arrow-red)"/>
  <text x="280" y="650" font-family="Arial" font-size="10">7. LLM响应</text>
  
  <!-- 核心服务回到客户端 -->
  <line x1="350" y1="325" x2="300" y2="150" stroke="#666" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="280" y="230" font-family="Arial" font-size="10">9. 返回最终响应</text>
  
  <!-- 结果回写流程 -->
  <line x1="550" y1="810" x2="550" y2="820" stroke="#FF8C00" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrow-orange)"/>
  <text x="570" y="815" font-family="Arial" font-size="8">8a. 结果反馈</text>
  
  <line x1="550" y1="850" x2="700" y2="630" stroke="#FF8C00" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrow-orange)"/>
  <text x="600" y="750" font-family="Arial" font-size="10">8b. PUT /v1/memory/update</text>
  
  <!-- 数据存储连接 -->
  <line x1="200" y1="650" x2="200" y2="1050" stroke="#666" stroke-width="1" stroke-dasharray="5,3"/>
  <line x1="700" y1="650" x2="700" y2="1050" stroke="#666" stroke-width="1" stroke-dasharray="5,3"/>
</svg>
